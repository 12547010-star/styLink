<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>styLink - あなたの作るあの子のスタイル</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div id="side-menu" class="side-menu">
        <div class="logo">
            <img src="img/logo.png" alt="styLink logo">
        </div>
        <div class="user-profile">
            <img src="img/avatar_placeholder.png" alt="ユーザーアバター" class="profile-avatar">
            <p class="profile-name">ユーザー名</p>
        </div>
        <div class="user-switch">
            <select id="user-selector">
                <option value="いなば　けんしゅうろう">いなば　けんしゅうろう</option>
                <option value="くろだ　しおり">くろだ　しおり</option>
                <option value="なか　ゆき">なか　ゆき</option>
                <option value="まつもと　つばさ">まつもと　つばさ</option>
                <option value="ゲストA">ゲストA</option>
                <option value="ゲストB">ゲストB</option>
                <option value="ゲストC">ゲストC</option>
                <option value="ゲストD">ゲストD</option>
            </select>
        </div>
        <nav class="menu-items">
            <a href="#" class="menu-item active" data-page="home"><span class="material-icons">home</span> ホーム</a>
            <a href="#" class="menu-item" data-page="search"><span class="material-icons">search</span> サーチ</a>
            <a href="#" class="menu-item" data-page="timeline"><span class="material-icons">local_fire_department</span> みんなのオススメ</a>
            <a href="#" class="menu-item" data-page="try-on"><span class="material-icons">checkroom</span> 試着</a>
            <a href="#" class="menu-item" data-page="favorites"><span class="material-icons">favorite_border</span> お気に入り</a>
            <a href="#" class="menu-item" data-page="share-closet"><span class="material-icons">folder_shared</span> シェアクローゼット</a>
            <a href="#" class="menu-item" data-page="event"><span class="material-icons">event</span> イベント日程</a>
            <a href="#" class="menu-item" data-page="settings"><span class="material-icons">settings</span> 設定</a>
        </nav>
    </div>

    <div id="main-container" class="main-container">
        <div id="home-page" class="page active">
            <h2 class="page-title">ホーム</h2>
            <div class="user-info">
                <h3>あなたの情報</h3>
                <div class="profile-edit-container">
                    <div class="profile-item center-align">
                        <label for="icon-upload" class="icon-label">
                            <img src="img/avatar_placeholder.png" alt="アイコン" id="current-icon" class="profile-icon">
                            <input type="file" id="icon-upload" accept="image/*" class="file-input">
                        </label>
                        <div class="username-edit-wrapper">
                            <input type="text" id="username-input" class="username-input" placeholder="ユーザー名" value="ユーザー名" readonly>
                            <span class="edit-icon material-icons">edit</span>
                        </div>
                    </div>
                    <div class="profile-item">
                        <label for="height-input">身長</label>
                        <input type="number" id="height-input" class="input-field" placeholder="例：170">
                        <div class="toggle-and-label">
                            <div class="toggle-switch">
                                <input type="checkbox" id="height-public-toggle" class="toggle-input">
                                <label for="height-public-toggle" class="toggle-label"></label>
                            </div>
                            <span class="toggle-text">公開する</span>
                        </div>
                    </div>
                    <div class="profile-item">
                        <label for="tops-size-select">トップスのサイズ</label>
                        <select id="tops-size-select" class="input-field">
                            <option value="">選択してください</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                        <div class="toggle-and-label">
                            <div class="toggle-switch">
                                <input type="checkbox" id="tops-public-toggle" class="toggle-input">
                                <label for="tops-public-toggle" class="toggle-label"></label>
                            </div>
                            <span class="toggle-text">公開する</span>
                        </div>
                    </div>
                    <div class="profile-item">
                        <label for="bottoms-size-select">ボトムスのサイズ</label>
                        <select id="bottoms-size-select" class="input-field">
                            <option value="">選択してください</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                        <div class="toggle-and-label">
                            <div class="toggle-switch">
                                <input type="checkbox" id="bottoms-public-toggle" class="toggle-input">
                                <label for="bottoms-public-toggle" class="toggle-label"></label>
                            </div>
                            <span class="toggle-text">公開する</span>
                        </div>
                    </div>
                    <div class="profile-item">
                        <label>顔写真</label>
                        <button class="image-upload-btn">
                            <span class="material-icons">camera_alt</span>
                        </button>
                        <div class="toggle-and-label">
                            <div class="toggle-switch">
                                <input type="checkbox" id="face-public-toggle" class="toggle-input">
                                <label for="face-public-toggle" class="toggle-label"></label>
                            </div>
                            <span class="toggle-text">公開する</span>
                        </div>
                    </div>
                    <div class="profile-item">
                        <label>ボディ写真</label>
                        <button class="image-upload-btn">
                            <span class="material-icons">camera_alt</span>
                        </button>
                        <div class="toggle-and-label">
                            <div class="toggle-switch">
                                <input type="checkbox" id="body-public-toggle" class="toggle-input">
                                <label for="body-public-toggle" class="toggle-label"></label>
                            </div>
                            <span class="toggle-text">公開する</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="favorite-items">
                <h3>あなたのお気に入り</h3>
                <div id="favorites-grid" class="item-grid">
                </div>
            </div>
        </div>

        <div id="search-page" class="page hidden">
            <header class="app-header">
                <div class="search-bar-container">
                    <input type="text" id="search-bar" class="search-bar" placeholder="         アイテムを検索">
                    <span class="search-icon material-icons">search</span>
                    <span class="clear-icon material-icons">close</span>
                </div>
            </header>
            <div class="main-content">
                <div class="item-grid-container">
                    <div id="item-grid" class="item-grid">
                    </div>
                </div>
            </div>
            <div class="filter-button">
                <span class="material-icons">filter_list</span>
                絞り込み
            </div>
        </div>

        <div id="timeline-page" class="page hidden">
            <h2 class="page-title">
                みんなのオススメを見る
                <button id="post-button" class="post-button">
                    <span class="material-icons">edit</span> 投稿
                </button>
            </h2>
            <div class="timeline-tabs">
                <div class="timeline-tab active" data-tab="recommended">おすすめ</div>
                <div class="timeline-tab" data-tab="following">フォロー中</div>
            </div>
            <div id="timeline-container">
            </div>
        </div>

        <div id="try-on-page" class="page hidden">
            <h2 class="page-title">試着</h2>
            <div class="try-on-container">
                <div class="mannequin-container">
                    <img src="img/mannequin.png" alt="マネキン" class="mannequin-image">
                    <img id="try-on-tops" class="try-on-item-image tops-layer" src="" alt="トップス">
                    <img id="try-on-bottoms" class="try-on-item-image bottoms-layer" src="" alt="ボトムス">
                    <img id="try-on-shoes" class="try-on-item-image shoes-layer" src="" alt="シューズ">
                </div>
                <div class="try-on-controls">
                    <div class="try-on-tabs">
                        <div class="try-on-tab active" data-category="tops">トップス</div>
                        <div class="try-on-tab" data-category="bottoms">ボトムス</div>
                        <div class="try-on-tab" data-category="shoes">シューズ</div>
                    </div>
                    <div class="item-selection-grid">
                    </div>
                </div>
            </div>
        </div>

        <div id="favorites-page" class="page hidden">
            <h2 class="page-title">お気に入り</h2>
            <div id="all-favorites-grid" class="item-grid">
            </div>
        </div>

        <div id="share-closet-page" class="page hidden">
            <h2 class="page-title">シェアクローゼット</h2>
            <div class="share-closet-tabs">
                <div class="share-closet-tab active" data-tab="shared-with">シェアされたアイテム</div>
                <div class="share-closet-tab" data-tab="shared-by">シェアしたアイテム</div>
            </div>
            <div id="shared-with-container" class="shared-items-container active">
            </div>
            <div id="shared-by-container" class="shared-items-container hidden">
            </div>
        </div>

        <div id="event-page" class="page hidden">
            <h2 class="page-title">
                リアルイベント
                <button id="add-event-button" class="add-event-button">
                    <span class="material-icons">add</span> 予定を追加
                </button>
            </h2>
            <div class="event-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <span id="prev-month" class="material-icons">chevron_left</span>
                        <h3 id="current-month-year"></h3>
                        <span id="next-month" class="material-icons">chevron_right</span>
                    </div>
                    <div class="calendar-days">
                        <span>日</span>
                        <span>月</span>
                        <span>火</span>
                        <span>水</span>
                        <span>木</span>
                        <span>金</span>
                        <span>土</span>
                    </div>
                    <div id="calendar-dates" class="calendar-dates">
                    </div>
                </div>
                <div class="event-list-container">
                    <h3>今日の予定</h3>
                    <ul id="event-list">
                    </ul>
                </div>
            </div>
        </div>

        <div id="settings-page" class="page hidden">
            <h2 class="page-title">設定</h2>
            <div class="setting-item">
                <p>ローカルデータをすべてクリア</p>
                <button id="clear-local-storage-button" class="action-button">クリア</button>
            </div>
        </div>

        <div id="friend-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>誰に送りますか？</h3>
                    <span class="modal-close material-icons">close</span>
                </div>
                <div id="friend-list" class="friend-list-container">
                </div>
            </div>
        </div>

        <div id="post-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>新しい投稿</h3>
                    <span id="post-modal-close" class="modal-close material-icons">close</span>
                </div>
                <div class="post-form">
                    <textarea id="post-caption" placeholder="キャプションを入力..." rows="4"></textarea>
                    <label for="post-image-upload" class="image-upload-label">
                        <span class="material-icons">add_photo_alternate</span> 写真を選択
                        <input type="file" id="post-image-upload" accept="image/*" class="file-input" multiple>
                    </label>
                    <div id="post-preview-container" class="post-preview-container"></div>
                    <button id="submit-post-button" class="submit-post-button">投稿する</button>
                </div>
            </div>
        </div>

        <div id="event-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>予定を追加</h3>
                    <span id="event-modal-close" class="modal-close material-icons">close</span>
                </div>
                <div class="event-form">
                    <label for="event-title-input">タイトル</label>
                    <input type="text" id="event-title-input" class="input-field" placeholder="予定のタイトル">

                    <label for="event-date-input">日付</label>
                    <input type="date" id="event-date-input" class="input-field">

                    <label for="event-time-input">時間</label>
                    <input type="time" id="event-time-input" class="input-field">

                    <button id="save-event-button" class="save-event-button">保存</button>
                </div>
            </div>
        </div>

        <div id="image-modal" class="modal-overlay hidden">
            <div class="modal-content image-modal-content">
                <span id="image-modal-close" class="modal-close material-icons">close</span>
                <img id="modal-image" src="" alt="拡大画像">
            </div>
        </div>

    </div>

    <script>
        // LocalStorageからデータを取得する関数
        function getStoredData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        // LocalStorageにデータを保存する関数
        function saveStoredData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const itemGrid = document.getElementById('item-grid');
            const searchBar = document.getElementById('search-bar');
            const friendModal = document.getElementById('friend-modal');
            const modalCloseBtn = document.querySelector('#friend-modal .modal-close');

            const menuItems = document.querySelectorAll('.menu-item');
            const pages = document.querySelectorAll('.page');
            const favoritesGrid = document.getElementById('favorites-grid');
            const allFavoritesGrid = document.getElementById('all-favorites-grid');

            const iconUpload = document.getElementById('icon-upload');
            const currentIcon = document.getElementById('current-icon');
            const usernameInput = document.getElementById('username-input');
            const editIcon = document.querySelector('.edit-icon');
            const profileName = document.querySelector('.profile-name');
            const profileAvatar = document.querySelector('.profile-avatar');
            const userSelector = document.getElementById('user-selector');
            const friendListContainer = document.getElementById('friend-list');

            const timelineContainer = document.getElementById('timeline-container');
            const timelineTabs = document.querySelectorAll('.timeline-tab');
            const postButton = document.getElementById('post-button');
            const postModal = document.getElementById('post-modal');
            const postModalClose = document.getElementById('post-modal-close');
            const postCaptionInput = document.getElementById('post-caption');
            const postImageUpload = document.getElementById('post-image-upload');
            const postPreviewContainer = document.getElementById('post-preview-container');
            const submitPostButton = document.getElementById('submit-post-button');

            const sharedWithContainer = document.getElementById('shared-with-container');
            const sharedByContainer = document.getElementById('shared-by-container');
            const shareClosetTabs = document.querySelectorAll('.share-closet-tab');

            const imageModal = document.getElementById('image-modal');
            const imageModalClose = document.getElementById('image-modal-close');
            const modalImage = document.getElementById('modal-image');

            const tryOnTabs = document.querySelectorAll('.try-on-tab');
            const itemSelectionGrid = document.querySelector('.item-selection-grid');
            const tryOnTops = document.getElementById('try-on-tops');
            const tryOnBottoms = document.getElementById('try-on-bottoms');
            const tryOnShoes = document.getElementById('try-on-shoes');

            const calendarDates = document.getElementById('calendar-dates');
            const currentMonthYear = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const addEventButton = document.getElementById('add-event-button');
            const eventModal = document.getElementById('event-modal');
            const eventModalClose = document.getElementById('event-modal-close');
            const eventTitleInput = document.getElementById('event-title-input');
            const eventDateInput = document.getElementById('event-date-input');
            const eventTimeInput = document.getElementById('event-time-input');
            const saveEventButton = document.getElementById('save-event-button');
            const eventList = document.getElementById('event-list');
            const clearLocalStorageButton = document.getElementById('clear-local-storage-button');


            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let selectedDate = new Date();

            const dummyUsers = [
                { name: 'いなば　けんしゅうろう', userId: '@inaba', avatar: 'img/avatar_placeholder.png' },
                { name: 'くろだ　しおり', userId: '@kuroda', avatar: 'img/avatar_placeholder.png' },
                { name: 'なか　ゆき', userId: '@naka', avatar: 'img/avatar_placeholder.png' },
                { name: 'まつもと　つばさ', userId: '@matsumoto', avatar: 'img/avatar_placeholder.png' },
                { name: 'ゲストA', userId: '@guestA', avatar: 'img/avatar_placeholder.png' },
                { name: 'ゲストB', userId: '@guestB', avatar: 'img/avatar_placeholder.png' },
                { name: 'ゲストC', userId: '@guestC', avatar: 'img/avatar_placeholder.png' },
                { name: 'ゲストD', userId: '@guestD', avatar: 'img/avatar_placeholder.png' },
            ];

            const dummyFriends = dummyUsers.slice(1);
            let events = getStoredData('events') || {};
            let dummyShareHistory = getStoredData('dummyShareHistory') || [];
            let dummyPosts = getStoredData('dummyPosts') || [
                { user: 'くろだ　しおり', userId: '@kuroda', images: ['img/item1.png'], caption: '今日のコーデです！古着のスウェットがお気に入り。', likes: 125, comments: 5 },
                { user: 'なか　ゆき', userId: '@naka', images: ['img/item1.png', 'img/item1.png'], caption: '最近買ったジャケット、めちゃくちゃ形がいい。', likes: 88, comments: 2 },
                { user: 'まつもと　つばさ', userId: '@matsumoto', images: ['img/item1.png', 'img/item1.png', 'img/item1.png'], caption: 'このスニーカー、どんな服に合わせようか迷うなぁ。', likes: 201, comments: 10 },
                { user: 'ゲストA', userId: '@guestA', images: ['img/item1.png'], caption: '新しいフーディー、これからの季節に大活躍しそう！', likes: 55, comments: 3 },
                { user: 'ゲストB', userId: '@guestB', images: ['img/item1.png'], caption: 'ジャケットスタイルに挑戦！どうかな？', likes: 72, comments: 8 }
            ];

            const allDummyItems = [
                { name: 'Tシャツ', price: '¥11,000', imageUrl: 'img/item1.png', id: 'item1', category: 'tops' },
                { name: 'スウェット', price: '¥13,200', imageUrl: 'img/item1.png', id: 'item2', category: 'tops' },
                { name: 'Tシャツ/カットソー', price: '¥11,000', imageUrl: 'img/item1.png', id: 'item3', category: 'tops' },
                { name: 'フーディー', price: '¥9,800', imageUrl: 'img/item1.png', id: 'item4', category: 'tops' },
                { name: 'ジャケット', price: '¥15,000', imageUrl: 'img/item1.png', id: 'item5', category: 'tops' },
                { name: 'ブルゾン', price: '¥12,500', imageUrl: 'img/item1.png', id: 'item6', category: 'tops' },
                { name: 'Tシャツ', price: '¥11,000', imageUrl: 'img/item1.png', id: 'item7', category: 'tops' },
                { name: 'スウェット', price: '¥13,200', imageUrl: 'img/item1.png', id: 'item8', category: 'bottoms' },
                { name: 'Tシャツ/カットソー', price: '¥11,000', imageUrl: 'img/item1.png', id: 'item9', category: 'bottoms' },
                { name: 'フーディー', price: '¥9,800', imageUrl: 'img/item1.png', id: 'item10', category: 'shoes' },
                { name: 'ジャケット', price: '¥15,000', imageUrl: 'img/item1.png', id: 'item11', category: 'shoes' },
                { name: 'ブルゾン', price: '¥12,500', imageUrl: 'img/item1.png', id: 'item12', category: 'shoes' },
                { name: 'Tシャツ', price: '¥11,000', imageUrl: 'img/item1.png', id: 'item13', category: 'shoes' },
                { name: 'スウェット', price: '¥13,200', imageUrl: 'img/item1.png', id: 'item14', category: 'tops' },
                { name: 'Tシャツ/カットソー', price: '¥11,000', imageUrl: 'img/item1.png', id: 'item15', category: 'bottoms' },
            ];

            let favoriteItems = getStoredData('favoriteItems');

            function switchUser(userName) {
                const user = dummyUsers.find(u => u.name === userName);
                if (user) {
                    profileName.textContent = user.name;
                    profileAvatar.src = user.avatar;
                    usernameInput.value = user.name;
                    currentIcon.src = user.avatar;

                    const sharedWithItems = dummyShareHistory.filter(item => item.recipientName === userName);
                    renderSharedItems(sharedWithItems, sharedWithContainer);

                    const sharedByItems = dummyShareHistory.filter(item => item.sharerName === userName);
                    renderSharedItems(sharedByItems, sharedByContainer, true);
                }
            }

            function renderItems(items, gridElement, isFavoritePage = false) {
                gridElement.innerHTML = '';
                items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';

                    const isFavorited = favoriteItems.some(fav => fav.id === item.id);
                    const favIconClass = isFavorited ? 'favorite' : 'favorite_border';
                    const favIconColorClass = isFavorited ? 'favorited' : '';

                    itemCard.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" class="item-image">
                        <div class="item-details">
                            <p class="item-name">${item.name}</p>
                            <p class="item-price">${item.price}</p>
                        </div>
                        <span class="favorite-icon material-icons ${favIconColorClass}" data-item-id="${item.id}">${favIconClass}</span>
                        ${isFavoritePage ? '' : '<div class="send-to-friend-btn">styLink!</div>'}
                    `;
                    gridElement.appendChild(itemCard);

                    const sendBtn = itemCard.querySelector('.send-to-friend-btn');
                    if (sendBtn) {
                        sendBtn.addEventListener('click', () => {
                            friendModal.classList.remove('hidden');
                            friendModal.dataset.selectedItemId = item.id;
                        });
                    }

                    const favIcon = itemCard.querySelector('.favorite-icon');
                    favIcon.addEventListener('click', () => {
                        toggleFavorite(item);
                    });
                });
            }

            function renderTryOnItems(category) {
                itemSelectionGrid.innerHTML = '';
                const itemsToDisplay = allDummyItems.filter(item => item.category === category);
                itemsToDisplay.forEach(item => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = item.imageUrl;
                    thumbnail.alt = item.name;
                    thumbnail.className = 'try-on-thumbnail';
                    thumbnail.dataset.imageUrl = item.imageUrl;
                    thumbnail.addEventListener('click', () => {
                        switch (category) {
                            case 'tops':
                                tryOnTops.src = item.imageUrl;
                                break;
                            case 'bottoms':
                                tryOnBottoms.src = item.imageUrl;
                                break;
                            case 'shoes':
                                tryOnShoes.src = item.imageUrl;
                                break;
                        }
                    });
                    itemSelectionGrid.appendChild(thumbnail);
                });
            }

            function renderCalendar(month, year) {
                calendarDates.innerHTML = '';
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startingDay = firstDay.getDay();

                currentMonthYear.textContent = `${year}年 ${month + 1}月`;
                for (let i = 0; i < startingDay; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day empty';
                    calendarDates.appendChild(dayCell);
                }

                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day';
                    dayCell.textContent = i;
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayCell.dataset.date = dateString;
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayCell.classList.add('active');
                    }
                    if (events[dateString] && events[dateString].length > 0) {
                        const eventDot = document.createElement('span');
                        eventDot.className = 'event-dot';
                        dayCell.appendChild(eventDot);
                    }
                    dayCell.addEventListener('click', (e) => {
                        document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        selectedDate = new Date(year, month, i);
                        renderEvents(dateString);
                    });
                    calendarDates.appendChild(dayCell);
                }
            }

            function renderEvents(dateString) {
                eventList.innerHTML = '';
                const todaysEvents = events[dateString] || [];
                if (todaysEvents.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = '予定はありません。';
                    li.className = 'no-events';
                    eventList.appendChild(li);
                } else {
                    todaysEvents.forEach(event => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${event.title}</strong><br><small>${event.time}</small>`;
                        eventList.appendChild(li);
                    });
                }
            }

            function renderTimeline(posts) {
                timelineContainer.innerHTML = '';
                posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    const imageHtml = post.images.length > 0 ?
                        `<div class="post-image-container ${post.images.length > 1 ? 'multiple' : ''}">
                            ${post.images.map(img => `<img src="${img}" alt="投稿画像" class="timeline-post-image ${post.images.length > 1 ? 'multiple' : ''}">`).join('')}
                        </div>` : '';
                    postCard.innerHTML = `
                        <div class="post-header">
                            <img src="${dummyUsers.find(u => u.name === post.user)?.avatar}" alt="${post.user}のアバター" class="post-avatar">
                            <div class="post-user-info">
                                <p class="post-username">${post.user}</p>
                                <p class="post-id">${post.userId}</p>
                            </div>
                        </div>
                        <div class="post-body">
                            <p>${post.caption}</p>
                            ${imageHtml}
                        </div>
                        <div class="post-actions">
                            <div class="action-item"><span class="material-icons">favorite_border</span> ${post.likes}</div>
                            <div class="action-item"><span class="material-icons">chat_bubble_outline</span> ${post.comments}</div>
                            <div class="action-item"><span class="material-icons">share</span></div>
                        </div>
                    `;
                    timelineContainer.prepend(postCard);

                    const postImages = postCard.querySelectorAll('.timeline-post-image');
                    postImages.forEach(img => {
                        img.addEventListener('click', (e) => {
                            modalImage.src = e.target.src;
                            imageModal.classList.remove('hidden');
                        });
                    });
                });
            }

            function renderSharedItems(items, container, isSharedBy = false) {
                container.innerHTML = '';
                if (items.length === 0) {
                    const message = isSharedBy ? 'まだアイテムをシェアしていません。' : 'まだシェアされたアイテムはありません。';
                    container.innerHTML = `<p style="text-align: center; margin-top: 50px; color: #777;">${message}</p>`;
                } else {
                    items.forEach(item => {
                        const sharedCard = document.createElement('div');
                        sharedCard.className = 'shared-item-card';
                        const headerText = isSharedBy
                            ? `<span>${item.recipientName}さんにシェアしました</span>`
                            : `<span>${item.sharerName}さんからシェアされました</span>`;
                        sharedCard.innerHTML = `
                            <div class="shared-item-header">
                                <img src="${item.sharerAvatar}" alt="${item.sharerName}のアバター" class="shared-item-avatar">
                                <div class="shared-item-info">
                                    <p class="shared-from-name">${headerText}</p>
                                    <p class="shared-date">${item.date}</p>
                                </div>
                            </div>
                            <img src="${item.imageUrl}" alt="${item.name}" class="shared-item-image">
                            <div class="shared-item-details">
                                <p class="shared-item-name">${item.name}</p>
                                <p class="shared-item-price">${item.price}</p>
                            </div>
                        `;
                        container.appendChild(sharedCard);
                    });
                }
            }


            function toggleFavorite(item) {
                const index = favoriteItems.findIndex(fav => fav.id === item.id);
                if (index > -1) {
                    favoriteItems.splice(index, 1);
                } else {
                    favoriteItems.push(item);
                }
                saveStoredData('favoriteItems', favoriteItems);
                updateFavorites();
            }

            function updateFavorites() {
                const homeFavs = favoriteItems.slice(0, 4);
                renderItems(homeFavs, favoritesGrid);
                renderItems(favoriteItems, allFavoritesGrid, true);
                renderItems(allDummyItems, itemGrid);
            }

            updateFavorites();
            renderItems(allDummyItems, itemGrid);

            if (searchBar) {
                searchBar.addEventListener('input', () => {
                    const query = searchBar.value.toLowerCase();
                    const filteredItems = allDummyItems.filter(item =>
                        item.name.toLowerCase().includes(query)
                    );
                    renderItems(filteredItems, itemGrid);
                });
            }

            dummyFriends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.innerHTML = `
                    <img src="${friend.avatar}" alt="${friend.name}のアバター" class="friend-avatar">
                    <span class="friend-name">${friend.name}</span>
                `;
                friendListContainer.appendChild(friendItem);

                friendItem.addEventListener('click', () => {
                    const selectedItemId = friendModal.dataset.selectedItemId;
                    const selectedItem = allDummyItems.find(item => item.id === selectedItemId);
                    const currentUser = userSelector.value;

                    if (selectedItem) {
                        const now = new Date();
                        const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;

                        const sharedItem = {
                            ...selectedItem,
                            sharerName: currentUser,
                            sharerAvatar: dummyUsers.find(u => u.name === currentUser)?.avatar,
                            recipientName: friend.name,
                            date: formattedDate
                        };

                        dummyShareHistory.push(sharedItem);
                        saveStoredData('dummyShareHistory', dummyShareHistory);
                        alert(`${friend.name}さんにアイテムをシェアしました！`);
                        friendModal.classList.add('hidden');
                        switchUser(currentUser);
                    }
                });
            });

            menuItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = item.dataset.page;
                    menuItems.forEach(menu => menu.classList.remove('active'));
                    item.classList.add('active');
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(targetPage + '-page').classList.add('active');

                    if (targetPage === 'search') {
                        renderItems(allDummyItems, itemGrid);
                    } else if (targetPage === 'timeline') {
                        renderTimeline(dummyPosts);
                    } else if (targetPage === 'favorites') {
                        updateFavorites();
                    } else if (targetPage === 'share-closet') {
                        switchUser(userSelector.value);
                    } else if (targetPage === 'try-on') {
                        renderTryOnItems('tops');
                    } else if (targetPage === 'event') {
                        renderCalendar(currentMonth, currentYear);
                        const today = new Date();
                        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        renderEvents(todayString);
                    }
                });
            });

            editIcon.addEventListener('click', () => {
                usernameInput.readOnly = !usernameInput.readOnly;
                usernameInput.focus();
            });

            userSelector.addEventListener('change', (e) => {
                switchUser(e.target.value);
            });

            modalCloseBtn.addEventListener('click', () => {
                friendModal.classList.add('hidden');
            });

            postButton.addEventListener('click', () => {
                postModal.classList.remove('hidden');
            });

            postModalClose.addEventListener('click', () => {
                postModal.classList.add('hidden');
            });

            submitPostButton.addEventListener('click', () => {
                const caption = postCaptionInput.value;
                const currentUser = userSelector.value;
                const newPost = {
                    user: currentUser,
                    userId: dummyUsers.find(u => u.name === currentUser)?.userId,
                    images: ['img/item1.png'],
                    caption: caption,
                    likes: 0,
                    comments: 0
                };
                dummyPosts.unshift(newPost);
                saveStoredData('dummyPosts', dummyPosts);
                renderTimeline(dummyPosts);
                postModal.classList.add('hidden');
                postCaptionInput.value = '';
                postPreviewContainer.innerHTML = '';
            });

            shareClosetTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    shareClosetTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    if (tab.dataset.tab === 'shared-with') {
                        sharedWithContainer.classList.add('active');
                        sharedByContainer.classList.remove('active');
                    } else {
                        sharedWithContainer.classList.remove('active');
                        sharedByContainer.classList.add('active');
                    }
                });
            });

            imageModalClose.addEventListener('click', () => {
                imageModal.classList.add('hidden');
            });

            tryOnTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tryOnTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderTryOnItems(tab.dataset.category);
                });
            });

            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentMonth, currentYear);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            });

            addEventButton.addEventListener('click', () => {
                eventDateInput.value = selectedDate.toISOString().split('T')[0];
                eventModal.classList.remove('hidden');
            });

            eventModalClose.addEventListener('click', () => {
                eventModal.classList.add('hidden');
            });

            saveEventButton.addEventListener('click', () => {
                const title = eventTitleInput.value;
                const date = eventDateInput.value;
                const time = eventTimeInput.value;
                if (title && date) {
                    if (!events[date]) {
                        events[date] = [];
                    }
                    events[date].push({ title, time });
                    saveStoredData('events', events);
                    renderCalendar(currentMonth, currentYear);
                    renderEvents(date);
                    eventModal.classList.add('hidden');
                    eventTitleInput.value = '';
                } else {
                    alert('タイトルと日付を入力してください。');
                }
            });

            clearLocalStorageButton.addEventListener('click', () => {
                if (confirm('すべてのローカルデータをクリアしますか？この操作は元に戻せません。')) {
                    localStorage.clear();
                    alert('データがクリアされました。ページをリロードします。');
                    window.location.reload();
                }
            });

            switchUser('いなば　けんしゅうろう');
            renderItems(allDummyItems, itemGrid);
            renderTimeline(dummyPosts);
        });
    </script>
</body>

</html>